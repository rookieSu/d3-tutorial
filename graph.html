<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="./data.js"></script>
    <script src="./js/d3.7.6.1.js"></script>
    <title>Document</title>
  </head>
  <body>
    <div style="width: 100%; height: 600px">
      <svg width="100%" height="600"></svg>
    </div>
  </body>
  <script>
    console.log(nodes, links);
    let zoneWidth = 200;
    let startX = 80;
    let startY = 150;
    let verticalMargin = 150;
    let horizontalMargin = 200;
    let horizontalZones = ["USER", "WEB", "APP", "MIDDLEWARE", "DATA", "OUTER"];
    let verticalZones = Object.keys(nodes);
    let allNodes = [];
    let linkInfo = {};
    let maxNodes = 0;
    verticalZones.forEach((vz, i) => {
      let y = maxNodes * verticalMargin + startY;
      let horizontalZoneNodes = nodes[vz]; // 提取单个横向分区的所有数据
      maxNodes = 0;
      horizontalZones.forEach((hz, j) => {
        let singleHorizontalZoneNodes = horizontalZoneNodes[hz];
        maxNodes =
          singleHorizontalZoneNodes.length > maxNodes
            ? singleHorizontalZoneNodes.length
            : maxNodes;
        singleHorizontalZoneNodes.forEach((node, k) => {
          if (k) {
            node.x = j * horizontalMargin + startX;
            node.y = singleHorizontalZoneNodes[k - 1].y + verticalMargin;
          } else {
            node.x = j * horizontalMargin + startX;
            node.y = y;
          }
          allNodes.push(node);
          linkInfo[node.id] = {
            ...node,
          };
          if (node.instance) {
            //待写
          }
        });
      });
    });
    let dragStartPosition = [];
    let dPostions = [0, 0];
    let dx, dy;
    let drag = d3
      .drag()
      .on("start", function (event) {
        dragStartPosition[0] = event.x;
        dragStartPosition[1] = event.y;
      })
      .on("drag", function (event) {
        dx = event.x - dragStartPosition[0] + dPostions[0];
        dy = event.y - dragStartPosition[1] + dPostions[1];
        d3.select("svg g").attr("transform", `translate(${dx} ${dy})`);
      })
      .on("end", function (event) {
        //记录上一次移动位置
        dPostions[0] = dx;
        dPostions[1] = dy;
      });
    let zoom = d3.zoom().on("zoom", function (e) {
      let currentTransform = d3.select("#main-group").attr("transform") || "";
      let matchScale = /scale\([0-9.]*\)/g;
      if (e.sourceEvent.wheelDelta > 0) {
        scale = scale + 0.1;
      } else {
        scale = scale - 0.1;
      }
      if (currentTransform.match(matchScale)) {
        currentTransform = currentTransform.replace(matchScale, `scale(${scale})`);
      } else {
        currentTransform = `${currentTransform} scale(${scale})`
      }
      d3.select("#main-group").attr(
          "transform",
          `${currentTransform}`
        );
    });
    let defs = d3.select("svg").append("defs");
    let arrowMarker = defs
      .append("marker")
      .attr("id", "arrow")
      .attr("markerUnits", "strokeWidth")
      .attr("markerWidth", "12")
      .attr("markerHeight", "12")
      .attr("viewBox", "0 0 12 12")
      .attr("refX", "6")
      .attr("refY", "6")
      .attr("orient", "auto");

    let arrow_path = "M2,2 L10,6 L2,10 L6,6 L2,2";
    let scale = 1;
    arrowMarker.append("path").attr("d", arrow_path).attr("fill", "#000");

    let mainGroup = d3
      .select("svg")
      .call(drag)
      .call(zoom)
      .append("g")
      .attr("id", "main-group");
    mainGroup
      .append("g")
      .selectAll("rect")
      .data(allNodes)
      .join("rect")
      .attr("x", (d) => d.x)
      .attr("y", (d) => d.y)
      .attr("stroke", "blue")
      .attr("stroke-width", "2px")
      .attr("fill", "none")
      .attr("width", "100")
      .attr("height", "100");

    mainGroup
      .append("g")
      .selectAll("text")
      .data(allNodes)
      .join("text")
      .text((d) => d.id)
      .attr("x", (d) => d.x)
      .attr("y", (d) => d.y);

    mainGroup
      .append("g")
      .selectAll("path")
      .data(links)
      .join("path")
      .attr("d", ({ source, target }) => {
        let moveTo = `M ${linkInfo[source].x + 100} ${linkInfo[source].y + 50}`;
        let linkTo = `L ${linkInfo[target].x - 8} ${linkInfo[target].y + 50}`;
        return `${moveTo}  ${linkTo} `;
      })
      .attr("stroke", "blue")
      .attr("stroke-width", "2px")
      .attr("marker-end", "url(#arrow)");
  </script>
</html>
